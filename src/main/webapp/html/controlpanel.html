<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Add new lego</title>
<script>
var latestResponse = "";
function sendData(form){
	//Create a new Javascript object
	var lego=new Object();
	lego.colorvalue=form.colorvalue.value;
	lego.motorapower = form.motorapower.value;
	lego.motorbpower = form.motorbpower.value;
	lego.manualmode = document.getElementById("manual-mode").checked;
	
	var jsonLego=JSON.stringify(lego);
	var xhttp = new XMLHttpRequest();
	
	xhttp.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
	   document.getElementById("responseView").innerHTML = this.responseText;
	   latestResponse = JSON.parse(this.responseText);
	   var returned=JSON.parse(this.responseText);
	   document.getElementById("inparts").innerHTML="ID="+returned.id+" Color value="+returned.colorvalue+" Timestamp="+returned.time;
	   document.getElementById("legoID").innerText = "ID: " + returned.id;
       document.getElementById("colorValue").innerText = "Color Value: " + returned.colorvalue;
       document.getElementById("motorAPower").innerText = "MotorA Power: " + returned.motorapower;
       document.getElementById("motorBPower").innerText = "MotorB Power: " + returned.motorbpower;
       document.getElementById("manualMode").innerText = "Manual Mode: " + (returned.manualmode ? "Enabled" : "Disabled");
	  }
	};
	
	xhttp.open("POST","../rest/lego/setvalues",true);
	xhttp.setRequestHeader("Content-type","application/json");
	xhttp.send(jsonLego);
 
	
}

function setPower(motorAPower, motorBPower) {
	//Create a new Javascript object
 	var lego=new Object();
	//lego.colorvalue=form.colorvalue.value;
	lego.motorapower = motorAPower;
	lego.motorbpower = motorBPower;
	lego.manualmode = latestResponse.manualmode;
	
	var jsonLego=JSON.stringify(lego);
	var xhttp = new XMLHttpRequest();
	
	xhttp.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
	   document.getElementById("responseView").innerHTML = this.responseText;
	   var returned=JSON.parse(this.responseText);
	   latestResponse = JSON.parse(this.responseText);
	   document.getElementById("inparts").innerHTML="ID="+returned.id+" Color value="+returned.colorvalue+" Timestamp="+returned.time;
	   document.getElementById("legoID").innerText = "ID: " + returned.id;
       document.getElementById("colorValue").innerText = "Color Value: " + returned.colorvalue;
       document.getElementById("motorAPower").innerText = "MotorA Power: " + returned.motorapower;
       document.getElementById("motorBPower").innerText = "MotorB Power: " + returned.motorbpower;
       document.getElementById("manualMode").innerText = "Manual Mode: " + (returned.manualmode ? "Enabled" : "Disabled");
	   console.log(latestResponse)
	  }
	};
	
 	xhttp.open("POST","../rest/lego/setvalues",true);
	xhttp.setRequestHeader("Content-type","application/json");
	xhttp.send(jsonLego);
 
	
}
</script>
<script>


window.addEventListener("DOMContentLoaded", (event) => {
	const input = document.getElementById("page");
	input.addEventListener("keypress", checkKey);
});


function checkKey(e) {
	if (e.code == "KeyW") {
		if (latestResponse.motorapower == latestResponse.motorbpower) {
			const newMotorAPower = latestResponse.motorapower + 10;
			const newMotorBPower = latestResponse.motorbpower + 10;
			setPower(newMotorAPower, newMotorBPower);
		} else if (latestResponse.motorapower != latestResponse.motorbpower) {
			const average = (latestResponse.motorapower + latestResponse.motorbpower) / 2;
			setPower(average, average)
		}
		
	}
	
	if (e.code == "KeyS") {
		const newMotorAPower = latestResponse.motorapower - 10;
		const newMotorBPower = latestResponse.motorbpower - 10;
		setPower(newMotorAPower, newMotorBPower);
	}
	
	if (e.code == "KeyA") {
		const newMotorAPower = latestResponse.motorapower - 5;
		const newMotorBPower = latestResponse.motorbpower + 5;
		setPower(newMotorAPower, newMotorBPower);
	}
	
	if (e.code == "KeyD") {
		const newMotorAPower = latestResponse.motorapower + 5;
		const newMotorBPower = latestResponse.motorbpower - 5;
		setPower(newMotorAPower, newMotorBPower);
	}
	//log.textContent += ` ${e.code}`;
}

//Reading data from database
function fetchStatistics() {
    // Make an AJAX request to fetch statistics from the server
    fetch('http://192.168.1.11:8080/rest/lego/getstatistics')
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            // Update HTML elements with the received statistics
            document.getElementById('batteryVoltage').innerText = data.battery_voltage;
            var onLineTimeInSeconds = data.on_line_time / 1000;
            document.getElementById('onlineTime').innerText = onLineTimeInSeconds;
            // Add more lines to update other statistics as needed
            
        })
        .catch(function(error) {
            console.error('Error fetching statistics:', error);
        });
}

// Fetch statistics initially when the page loads
window.onload = function() {
    fetchStatistics();
    // Fetch statistics every 5 seconds (for example)
    setInterval(fetchStatistics, 1000);
};
</script>
</head>

<body id="page">
<h2>Fill in - this form uses AJAX</h2>
<form action="#" method='post' onsubmit='return false;'>
Color Value: <input id='color-value' type='text' name='colorvalue' value='' placeholder='New color value'><br>
MotorA Power: <input id='motor-a-power' type='text' name='motorapower' value='' placeholder='New motorA value'><br>
MotorB Power: <input id='motor-b-power' type='text' name='motorbpower' value='' placeholder='New motorB value'><br>
Manual Mode: <input id='manual-mode' type='checkbox' name='manualmode'><br>
Test: <input type='text' name='text' id='sample'>
<input type='button' name='ok' value='Send' onclick='sendData(this.form);'><br>
</form>
<p id='responseView'>The response will be shown here!
</p>
<p id='inparts'>The response in parts will be shown here!
</p>
<p id="legoID"></p>
<p id="colorValue"></p>
<p id="motorAPower"></p>
<p id="motorBPower"></p>
<p id="manualMode"></p>
<p id="log"></p>
<h1>Robot Statistics</h1>
<p>Battery Voltage: <span id="batteryVoltage"></span></p>
<p>On Line Time in seconds: <span id="onlineTime"></span></p>
</body>
</html>